App.Views.FilesList=Backbone.View.extend({initialize:function(e){this.files=e.files,this.listenTo(this.files,"add remove change:filename",this.render),this.render()},render:function(){this.tabs=[];var e=this;this.filteredFiles=this.filter?new Backbone.Collection(this.files.filter(this.filter)):this.files,this.$el.empty().append(this.filteredFiles.map(function(i,t){var s=new(Function.prototype.bind.call(e.view))({file:i,parent:e});return e.tabs.push(s),s.$el}))}}),App.Views.File=Backbone.View.extend({initialize:function(e){this.file=e.file,this.listenTo(this.file,"change",this.render),this.parent=e.parent,this.render()},render:function(){this.$el.html(App.Templates("editorTab")({filename:this.file.get("filename")})),this.prepare&&this.prepare()}}),App.Views.EditorTab=App.Views.File.extend({initialize:function(e){this._super(e),this.listenTo(this.file,"change:unsaved",this.setClasses),this.listenTo(this.file,"sync",this.setSynced)},events:{click:"setActive","click .close-tab":"close"},tagName:"a",prepare:function(){this.file.get("active")?this.$el.addClass("active"):this.$el.removeClass("active")},close:function(e){e.stopPropagation(),(this.file.isUnsaved||this.file.isNew).call(this.file)?window.confirm(App.Translations("editorTabCloseMessage"))&&(this.file.close(),this.file.isNew()&&this.file.destroy()):(this.file.close(),this.file.resetContent())},setActive:function(){App.Editor.switchCodeTab(this.file)},width:function(){return this.$el.outerWidth()},slideLeft:function(){var e=this.margin();return e<-1&&this.margin(Math.min(e+10,-1))},slideRight:function(){var e=this.width(),i=this.margin();if(i>-e){var t=this.parent.tabs;return minus=Math.min(t[t.length-1].position()-this.parent.width(),10),this.margin(Math.max(i-minus,-e))}return!1},position:function(){return this.$el.position().left+this.$el.outerWidth()},margin:function(e){return e?this.$el.css("margin-right",e+"px"):parseInt(this.$el.css("margin-right"),10)},render:function(){this._super(),this.file.get("opened")?this.show():this.hide(),this.setClasses()},setClasses:function(){this.$el.removeClass("unsaved"),this.file.get("unsaved")&&this.$el.addClass("unsaved")},setSynced:function(){this.file.set("unsaved",!1)},show:function(){this.$el.css("display","inline-block")},hide:function(){this.$el.css("display","none")}}),App.Views.EditorTabs=App.Views.FilesList.extend({view:App.Views.EditorTab,initialize:function(e){this.hideTab=0,this._super(e)},canSlideLeft:function(){return!!this.tabs[0].margin()+1},slideLeft:function(){if(!this.canSlideLeft())return!1;this.tabs[this.hideTab].slideLeft()||this.hideTab>0&&(this.hideTab-=1,this.slideLeft())},canSlideRight:function(){return this.tabs[this.tabs.length-1].position()>this.width()},slideRight:function(){if(!this.canSlideRight())return!1;this.tabs[this.hideTab].slideRight()||this.hideTab+1<this.tabs.length&&(this.hideTab+=1,this.slideRight())},width:function(){return this.$el.outerWidth()-6}}),App.Views.EditorTabsArrows=Backbone.View.extend({initialize:function(e){this.tabs=e.tabs,$("body").on("mouseup",$.proxy(this.stopSliding,this))},events:{"mousedown .slide-left":"slideLeft","mousedown .slide-right":"slideRight"},slideLeft:function(){this.slideLeftInterval=setInterval($.proxy(this.tabs.slideLeft,this.tabs),25)},slideRight:function(){this.slideRightInterval=setInterval($.proxy(this.tabs.slideRight,this.tabs),25)},stopSliding:function(){clearInterval(this.slideLeftInterval),clearInterval(this.slideRightInterval)}}),App.Views.EditorTabsContainer=Backbone.View.extend({initialize:function(e){this.tabs=new App.Views.EditorTabs({el:this.$(".tabs"),files:e.files}),this.arrows=new App.Views.EditorTabsArrows({el:this.$(".arrows"),parent:this,tabs:this.tabs})},width:function(){return this.$el.width()}}),App.Views.PreviewSelectOption=App.Views.File.extend({tagName:"option",prepare:function(){this.$el.attr("value",this.file.get("filename"))}}),App.Views.PreviewSelect=App.Views.FilesList.extend({view:App.Views.PreviewSelectOption,filter:function(e){return"html"==e.type()},render:function(){this._super(),this.filteredFiles.size()<2?this.$el.parent().addClass("display-none"):this.$el.parent().removeClass("display-none")}}),App.Views.Editor=Backbone.View.extend({events:function(){return{'click [data-action="layout-change"]':"layoutChange",'click [data-action="expand-preview"]':"previewExpand",'click [data-action="hide-preview"]':"hidePreview",'click [data-action="show-preview"]':"showPreview",'click [data-action="compress-preview"]':"previewCompress",'click [data-action="full-preview"]':"previewFull",'click [data-action="compact-preview"]':"previewCompact",'change [data-action="change-preview-file"]':"changePreviewFile"}},fetch:function(){this.model.fetch().done($.proxy(this.render,this))},initialize:function(){var e=_.browser();if(parseInt(e.version,10)<{Chrome:30,Firefox:30,Opera:10,Safari:7,MSIE:11}[e.name])return this.$el.html(App.Templates("editor")({})),this.$el.addClass("browser-unsupported");this.fetch()},cheatSheetToggle:function(){this.$(".cheat-sheet-container").toggleClass("open")},render:function(){this.$el.html(App.Templates("editor")(this.model.toJSON())),this.prepareView()},files:function(){return this.model.files()},initCustomScrollbar:function(e){return e.perfectScrollbar()},isEditorDefined:function(){return void 0!==this.editor},prepareView:function(){var e=this.files();this.tabsContainer=new App.Views.EditorTabsContainer({el:this.$(".ide .tabs-container"),files:e}),this.htmls=new App.Views.PreviewSelect({el:$("#preview-select"),files:e}),this.$(".splitter").splitter({splitVertical:!0,minLeft:360,minRight:360,splitbarClass:"vsplitbar splitter-handle"}),this.$ide=this.$(".ide"),this.$preview=this.$("#preview"),this.$previewSelect=this.$("#preview-select"),this.$iframe=this.$("#window iframe"),this.$splitter=this.$(".splitter"),this.$vsplitbar=this.$(".vsplitbar"),this.$hsplitbar=this.$(".hsplitbar"),(this.prepareAdditionalViews||$.noop).call(this),this.$("#editor").length&&(App.setAceEditor(),this.editor=ace.edit("editor"),this.editor.setTheme("ace/theme/monokai"),this.editor.getSession().setMode("ace/mode/html"),this.editor.getSession().setUseWrapMode(!0),this.editor.resize(),this.editor.getSession().setTabSize(4),this.editor.getSession().setUseSoftTabs(!1),this.editor.setBehavioursEnabled(!1),this.editor.setShowPrintMargin(!1),this.editor.getSession().setUseWorker(!1),$(window).width()>1366&&this.editor.setFontSize(14),this.$ide.on("resize",$.proxy(this.editor.resize,this.editor)),this.initCustomScrollbar(this.$(".ace_scrollbar, .csb-container, .cheat-sheet-container")),this.resizeFix())},resizeFix:function(){var e=this;$(window).on("resize",function(i){i.target===window&&($(window).off("resize"),setTimeout(function(){e.activateSplitter(),e.resizeFix()},2e3))})},removeSplittBar:function(){this.$(".vsplitbar, .hsplitbar").remove()},splitterOptions:{vertical:{splitVertical:!0,minLeft:360,minRight:360,splitbarClass:"vsplitbar splitter-handle"},horizontal:{splitHorizontal:!0,minTop:200,minBottom:200,splitbarClass:"hsplitbar splitter-handle"}},initSplitter:function(e){this.$(".splitter."+e).splitter(this.splitterOptions[e])},activateSplitter:function(){this.removeSplittBar(),this.$splitter.hasClass("vertical")?this.initSplitter("vertical"):this.$splitter.hasClass("horizontal")&&this.initSplitter("horizontal")},layoutChange:function(){this.$splitter.hasClass("vertical")?analytics.track(this.editorType+"_editor_preview_horizontal"):analytics.track(this.editorType+"_editor_preview_vertical"),this.$splitter.toggleClass("horizontal vertical"),this.activateSplitter(),this.editor.resize()},hidePreview:function(){this.removeSplittBar(),this.$preview.hide(),this.$ide.css({width:"100%",height:"100%"}),this.$('[data-action="show-preview"]').removeClass("display-none"),this.editor.resize()},showPreview:function(){this.activateSplitter(),this.$preview.show(),this.$preview.hasClass("expanded")&&this.previewExpand(),this.$('[data-action="show-preview"]').addClass("display-none"),this.editor.resize()},previewExpand:function(){this.removeSplittBar(),this.$("#ide-toggle").addClass("disabled"),this.$preview.addClass("expanded");var e=this;this.$(".expanded").draggable({drag:function(i,t){var s=e.$el.width()-e.$preview.width(),n=e.$el.height()-e.$preview.height();t.position.top=Math.max(0,t.position.top),t.position.left=Math.min(s,t.position.left),t.position.left=Math.max(0,t.position.left),t.position.top=Math.min(n,t.position.top)}}),this.$(".expanded").resizable({minHeight:200,minWidth:400}),this.$('[data-action="compress-preview"], [data-action="full-preview"]').removeClass("display-none"),this.$('[data-action="expand-preview"], [data-action="layout-change"]').addClass("display-none"),this.$splitter.hasClass("vertical")?this.$ide.width("100%"):this.$ide.height("100%"),this.$preview.css({height:"450px",width:"900px","z-index":"101",top:"calc(50vh - 290px)",left:"calc(50vw - 450px)"}).appendTo(this.$el),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_modal")},previewCompress:function(){this.$("#ide-toggle").removeClass("disabled"),this.$preview.removeClass("expanded"),this.$preview.draggable("destroy").resizable("destroy"),this.$('[data-action="expand-preview"], [data-action="layout-change"], [data-action="full-preview"]').removeClass("display-none"),this.$('[data-action="compress-preview"]').addClass("display-none"),this.$preview.appendTo(".splitter"),this.activateSplitter(),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_notmodal")},previewFull:function(e){this.$el.addClass("preview-maximized"),$(e.currentTarget).addClass("display-none"),this.$('[data-action="compact-preview"]').removeClass("display-none"),this.$('[data-action="layout-change"], [data-action="expand-preview"], [data-action="compress-preview"], [data-action="hide-preview"], [data-action="full-preview"]').addClass("display-none"),this.$preview.css({height:"100%",width:"100%","z-index":"101",top:"0",left:"0","background-color":"#fff"}).appendTo(this.$el).addClass("full"),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_full")},previewCompact:function(e){this.$el.removeClass("preview-maximized"),$(e.currentTarget).addClass("display-none"),this.$('[data-action="layout-change"], [data-action="expand-preview"], [data-action="hide-preview"], [data-action="full-preview"]').removeClass("display-none"),this.$('[data-action="compress-preview"], [data-action="compact-preview"]').addClass("display-none"),this.$preview.appendTo(".splitter").removeClass("full"),this.$ide.hasClass("display-none")?this.$preview.css({height:"100%",left:"0",width:"100%","z-index":"1",top:"0"}):this.$splitter.hasClass("vertical")?(this.$preview.css({height:"100%",left:"50%",width:"50%","z-index":"1"}),this.$ide.width("50%")):(this.$preview.css({height:"50%",left:"0",width:"100%","z-index":"1",top:"50%"}),this.$ide.height("50%")),this.activateSplitter(),this.updatePreview(),analytics.track(this.editorType+"_editor_preview_notfull")},changePreviewFile:function(){this.activePreviewFile=this.files().findWhere({filename:this.$previewSelect.val()}),this.updatePreview()},setActiveFile:function(e,i){if(this.activeFile=e,"html"===e.type()){var t=e.get("filename");this.$previewSelect.val(t),!i&&this.activePreviewFile&&this.activePreviewFile.get("filename")==t||(this.activePreviewFile=e,this.updatePreview())}if(this.isEditorDefined()){if(!this.activeFile.get("editorSession")||!1===this.activeFile.get("opened")){this.activeFile.set("editorSession",ace.createEditSession(this.activeFile.content()));this.activeFile.get("editorSession").setMode({html:"ace/mode/html",css:"ace/mode/css",sass:"ace/mode/sass",scss:"ace/mode/scss",js:"ace/mode/javascript",java:"ace/mode/java"}[this.activeFile.type()])}this.editor.setSession(this.activeFile.get("editorSession")),this.editor.setReadOnly(!1),this.editor.focus(),this.editor.getSession().on("change",$.proxy(this.onEditorContentChanged,this))}this.activeFile.set({active:!0,opened:!0})},setStartingFile:function(){var e=this.files().findWhere({type:"html"});if(void 0===e&&(e=this.files().findWhere({type:"java"})),e){var i=this;setTimeout(function(){e.updateBlob(),i.setActiveFile(e,!0)},0)}},switchCodeTab:function(e){analytics.track(this.editorType+"_editor_code_file_changed"),this.setActiveFile(e)},changeFileContent:function(e){this.activeFile.setContent(this.editor.getValue())},setPreviewTitle:function(e){var i=this.$preview.find("header > h2");i.html(App.Templates("previewTitle")({label:i.data("label"),title:e}))},prepareIframe:function(){this.activePreviewFile.injectDependenciesToIframe(this.$iframe);var e=this,i=this.$iframe.contents();this.setPreviewTitle(i.find("title").html()),i.find('[src^="/"]').each(function(){$(this).attr("src",top.location.origin+$(this).attr("src")),["video","audio"].indexOf($(this).parent().prop("tagName").toLowerCase())>=0&&$(this).parent().get(0).load()}),i.find("a").click(function(i){var t=$(this).attr("href"),s=e.files().findWhere({filename:t});if(s)return e.switchCodeTab(s),i.preventDefault(),i.stopPropagation(),!1})}}),App.Views.ExerciseEditor=App.Views.Editor.extend({events:function(){return $.extend({"click .aside-toggle":"asideToggle","click #reset-code-btn":"resetExercise"},this._super())},initialize:function(e){e.signUpModal&&this.listenTo(e.signUpModal,"show",function(){analytics.track("sign_up_modal_shown")});var i=this.$el.data();$.extend(this,i),this.model=this.exercise=this.createModel(i),this._super(e)},render:function(){this.files().invoke("open"),this._super(),setTimeout(function(){var e=this.$("#lesson-nav");e.scrollTop(0);var i=$("#lesson-nav [data-active]").offset().top;e.scrollTop(i-100),e.perfectScrollbar()},0)},prepareView:function(){this._super(),this.setStartingFile(),void 0!==this.editor&&this.editor.focus()},onEditorContentChanged:function(e){this.editor.silent||(this.changeFileContent(),clearTimeout(this.updatePreviewTimeout),this.updatePreviewTimeout=setTimeout($.proxy(this.updatePreview,this),500))},updatePreview:function(){this.activePreviewFile.loadToIframe(this.$iframe,!1,$.proxy(this.prepareIframe,this))},analyticsProps:function(){return{}},createModel:function(e){return new App.Models.Exercise($.extend({id:e.exerciseId},e))},asideToggle:function(){var e=this.analyticsProps();this.$("aside").hasClass("open")?analytics.track(this.editorType+"_editor_edu_content-list_closed",e):analytics.track(this.editorType+"_editor_edu_content-list_opened",e),this.$("#lesson-nav").toggleClass("open")},resetExercise:function(e,i){if(confirm($(e.currentTarget).data("confirm-text"))){analytics.track(this.editorType+"_editor_code_reset");var t=this;$.ajax({type:"POST",url:this.resetExerciseUrl()}).done(function(){t.files().invoke("hardReset"),t.editor.setValue(t.activeFile.content(),1),t.fetch()})}e.preventDefault()},saveExercise:function(e){var i={};return this.files().each(function(e){var t=e.get("filename");i[t]={content:e.content(),filename:t,id:e.get("id")}}),$.ajax({type:"POST",url:this.saveExerciseUrl(),data:{exerciseStatus:e,exerciseFiles:JSON.stringify(i)}})}}),App.Views.CourseEditor=App.Views.ExerciseEditor.extend({initialize:function(e){this.exercisePositionInCourse=parseInt(this.$el.data("exercisePositionInCourse"),10),this._super(e)},events:function(){return $.extend({"click .show-tip":"showTip","click #validate-code-btn":"validateCode","click #next-exercise-btn":"nextExercise","click #cheat-sheet-toggle":"cheatSheetToggle"},this._super())},prepareAdditionalViews:function(){this.$errorModal=$("#val-result-error"),this.$successModal=$("#val-result"),this.$nextExerciseButton=$("#next-exercise-btn"),this.$lessonList=$("#lesson-list")},analyticsProps:function(){return{course_id:this.courseId,exercise_id:this.exercise.get("id"),exercise_position_in_course:this.exercisePositionInCourse}},showTip:function(){analytics.track(this.editorType+"_editor_edu_show_tip",this.analyticsProps()),this.$(".tip").removeClass("display-none"),this.$("section.description > article").scrollTop(999999)},validateCode:function(){var e=this;return this.$("#validate-code-btn").addClass("in-progress"),setTimeout(function(){e.exercise.validate().then($.proxy(e.validationFinished,e))},811),!1},nextExercise:function(){analytics.track(this.editorType+"_editor_next_exercise",this.analyticsProps())},saveExerciseUrl:function(){return"/"+App.getLang()+"/editor/exercise/save/"+this.pathId+"/"+this.courseId+"/"+this.lessonId+"/"+this.exerciseId},resetExerciseUrl:function(){return"/"+App.getLang()+"/editor/exercise/reset/"+this.pathId+"/"+this.courseId+"/"+this.lessonId+"/"+this.exerciseId},showErrors:function(e){var i=this.files();this.$errorModal.find(".modal-content p").html(App.Templates("validationErrorModalDesc")({filename:i.size()<2?i.at(0).get("filename"):null})),this.$errorModal.find("ul").empty().append($.map(e,function(e){return $("<li>").html(e)})),this.$errorModal.modal("show")},showSuccess:function(){this.$successModal.modal("show"),this.$nextExerciseButton.removeClass("display-none"),this.$lessonList.find(".active").addClass("done")},validationFinished:function(e){this.$("#validate-code-btn").removeClass("in-progress");var i=this.analyticsProps(),t=this;e&&e.length?(analytics.track(this.editorType+"_editor_code_submit_wrong",i),this.saveExercise(0).done(function(){t.showErrors(e)})):(analytics.track(this.editorType+"_editor_code_submit_success",i),this.saveExercise(1).done(function(){currentExerciseIsDone||(currentExerciseIsDone=!0,t.updateNumberOfDoneExercisesInActiveCampaign()),t.showSuccess()}))},updateNumberOfDoneExercisesInActiveCampaign:function(){if(void 0===Cookies.get("activeCampaignContactId")||void 0===Cookies.get("activeCampaignContactEmail")){var e=Cookies.get("doneExercises");return void 0===e&&(e=0),e=parseInt(e,10)+1,void Cookies.set("doneExercises",e,{expires:2592e3})}$.ajax({url:"/"+App.getLang()+"/activeCampaign/increaseByOne",method:"POST",data:{id:Cookies.get("activeCampaignContactId"),email:Cookies.get("activeCampaignContactEmail"),fields:["DONE_EXERCISES"]}})},editorType:"course"}),App.Views.PlusExerciseEditor=App.Views.ExerciseEditor.extend({initialize:function(e){this.currentInstructionId=0,this.introductions=[],this.instructions=[],this._super(e)},createModel:function(e){return new App.Models.PlusExercise($.extend({id:e.exerciseId},e))},events:function(){return $.extend({"click #save-code-btn":"saveCode"},this._super())},render:function(){this._super(),this.aside=new App.Views.PlusExerciseAside({el:this.$("#aside"),exercise:this.model})},saveExerciseUrl:function(){return"/"+App.getLang()+"/plus-exercise/save/"+this.exerciseId+"?id="+this.exercise.get("userId")},resetExerciseUrl:function(){return"/"+App.getLang()+"/plus-exercise/reset/"+this.exerciseId+"?id="+this.exercise.get("userId")},saveCode:function(e){this.saveExercise(0)},editorType:"plus-exercise"}),App.Views.PlusExerciseAside=Backbone.View.extend({events:{"click #instruction-page-previous":"previousPage","click #instruction-page-next":"nextPage","click .progress-checkbox":"saveCheckboxes"},initialize:function(e){this.$introduction=this.$("#introduction"),this.$instruction=this.$("#instruction"),this.$percentage=this.$("#percentage"),this.$pageCount=this.$("#page-count"),this.exercise=e.exercise,this.pages=this.exercise.get("pages"),this.progress=this.exercise.get("progress"),this.progress||(this.progress=new App.Models.PlusExerciseProgress({progress:"",done:0}),this.progress.set("exercise",this.exercise)),this.progress.setAllCheckpoints(this.exercise.get("all_checkpoints")),this.currentPage=new Backbone.Model,this.setPage(this.pages.first()),this.listenTo(this.currentPage,"change",this.render),this.render()},render:function(){this.$introduction.html(_.cescape(this.currentPage.get("introduction"),!0)),this.$instruction.html(_.cescape(this.currentPage.get("instruction"),!0)),this.$percentage.html(this.progress.get("percentage")),this.preparePageCheckboxes()},setPage:function(e){this.currentPage.set(e.pick("id","instruction","introduction")),this.updatePageCount()},previousPage:function(){var e=this.pages.get(this.currentPage.get("id")-1);void 0!==e&&this.setPage(e)},nextPage:function(){var e=this.pages.get(this.currentPage.get("id")+1);void 0!==e&&this.setPage(e)},updatePageCount:function(){this.$pageCount.html(this.currentPage.get("id")+1+"/"+this.pages.length)},preparePageCheckboxes:function(){var e=this,i=1;this.$instruction.find("li").each(function(){var t=$(this),s=t.html(),n=e.currentPage.get("id")+"_"+i,r=$("<label>").addClass("c-input c-checkbox progress-checkbox"),a=$("<span>").addClass("c-indicator"),o=$("<input>").attr("type","checkbox").val(n);e.progress.checkIfChecked(n)&&o.prop("checked",!0),r.html(s).prepend(a).prepend(o),t.html("").prepend(r),i++})},saveCheckboxes:function(e){var i=$(e.currentTarget).find('input[type="checkbox"]');i.is(":checked")?this.progress.checked(i.val()):this.progress.unchecked(i.val()),this.$percentage.html(this.progress.get("percentage"))}});