$.fn.extend({animateCss:function(e){$(this).addClass("animated "+e).one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("animated "+e)})}}),App.Views.ProjectNavbar=Backbone.View.extend({initialize:function(e){this.editor=e.editor,this.$menu=this.$(".project-buttons")},events:{"click a[data-action]":"execAction","hover .project-buttons .dropdown-toggle":"menuHover"},execAction:function(e){this.editor[$(e.currentTarget).data("action")].apply(this.editor,arguments),e.preventDefault()},menuHover:function(e){var t=this.$menu.children(".dropdown.open");t.length&&(t.removeClass("open"),$(e.currentTarget).parent().addClass("open"))}}),App.Views.FileSaveModal=Backbone.View.extend({events:{"click .btn-save":"save","click .btn[data-dismiss]":"cancel","click .btn-create-folder":"createFolder",'keydown input[name="filename"]':"fileKeyDown"},initialize:function(){this.$filename=this.$('input[name="filename"]')},setEditor:function(e){return this.editor=e,this},enableDisableSaveButton:function(){var e=""===this.$filename.val();return this.$(".btn-save").prop("disabled",e),!e},fileKeyDown:function(e){var t=this;setTimeout(function(){t.enableDisableSaveButton()&&13==(e.which||e.keyCode)&&t.save()},0)},save:function(){var e=this,t=this.selectedNode(function(){return e.treeView.getNode(0)});this.defer.resolve(null,t.path,this.$('input[name="filename"]').val(),t)},clearFilename:function(){this.$filename.val("")},cancel:function(){this.defer.resolve(!0)},createFolder:function(){var e=this,t=this.selectedNode(function(){return e.treeView.getNode(0)}),i=this.treeView.addNode(t,{nodes:[],editable:!0,text:App.Translations("newFolder"),onSaved:function(){var i=this.text,n=[t.path,i];t.path||n.shift();var o={text:i,path:n.join("/"),nodes:[]};return e.trigger("folderCreated",t,o),o}});this.treeView.selectNode(i),this.treeView.revealNode(i)},selectedNode:function(e){var t=this.treeView.getSelected().pop();return!t&&e?e():t},prepareTreeView:function(){var e=this,t=this.$(".tree-view");try{t.treeview("destroy")}catch(e){}this.treeView=t.treeview({color:"#428bca",showBorder:!1,data:this.data,expandIcon:"fa fa-folder",collapseIcon:"fa fa-folder-o",onNodeSelected:function(t,i){e.treeView.expandNode(i.nodeId)},onNodeBuilded:function(t,i){new App.Views.TreeViewFolder({node:t,editor:e.editor,treeView:this,el:i,onDelete:function(){e.trigger("folderDeleted",t)}})},filter:function(e){return!e.file}}).data("treeview")},show:function(e){return this.data=e,this.defer=$.Deferred(),this.prepareTreeView(),this.$el.modal("show"),this.enableDisableSaveButton(),this.defer},hide:function(){this.$el.modal("hide")}}),App.Views.ProjectEditModal=Backbone.View.extend({events:{"show.bs.modal":"render","click .btn-save":"saveProject","submit form":"saveProject"},initialize:function(e){this.$name=this.$('textarea[name="name"]'),this.$description=this.$('textarea[name="description"]'),this.project=e.project,this.listenTo(this.project,"change:name change:description",this.render)},render:function(){this.$name.val(this.project.get("name")),this.$description.val(this.project.get("description"))},saveProject:function(e){e&&e.preventDefault(),this.project.set({name:this.$name.val(),description:this.$description.val()});var t=this;this.project.save().done(function(){t.$el.modal("hide")})}}),App.Views.ProjectEditor=App.Views.Editor.extend({initialize:function(e){this.isOwner=!!parseInt(this.$el.data("isOwner"),10),this.projectId=parseInt(this.$el.data("projectId"),10),this.navbar=new App.Views.ProjectNavbar({el:e.$navbar,editor:this}),this.fileSaveModal=e.fileSaveModal.setEditor(this),this.bootcampProjectReviewSubmitModal=e.bootcampProjectReviewSubmitModal,this.bootcampProjectReviewCard=e.bootcampProjectReviewCard,this.listenTo(this.fileSaveModal,"folderCreated",this.folderCreated),this.listenTo(this.fileSaveModal,"folderDeleted",this.folderDeleted),this.model=this.project=new App.Models.Project({id:this.projectId}),this.editModal=new App.Views.ProjectEditModal({el:e.$editModal,project:this.project}),this.treeViewNodes=new HashMap,this.$autosave=e.$navbar.find('[data-action="toggleAutosave"]').addClass("autosave-on"),this._super(e)},events:function(){return $.extend({"click .reload-preview":"reloadPreview","click .aside-toggle":"toggleAside",'click [data-action="show-manual-modal"]':"showManualModal"},this._super())},toggleAside:function(){this.$el.toggleClass("aside-minimized"),$("#bootcamp-project-review-card").toggleClass("minimal"),this.$preview.is(":visible")&&this.$el.children("#preview").length<1&&this.activateSplitter()},folderCreated:function(e,t){var i=this.treeViewNodes.get(e.dataObject);this.treeView.addNode(i,t,!1)},deleteFolder:function(e){return $.ajax({url:"/"+App.getLang()+"/project-folder",type:"DELETE",data:{project_id:this.project.id,path:e}})},folderDeleted:function(e){this.treeView.removeNode(this.treeViewNodes.get(e.dataObject))},setActiveFile:function(e,t){this._super(e,t);var i=e.get("treeNode");i&&this.treeView.selectNode(i),this.showHidePlug()},fileOpenedOrClosed:function(e){if(e.get("opened")||e.set("unsaved",!1),e.get("active")&&!e.get("opened")){var t=this.files().findWhere({opened:!0});t&&this.setActiveFile(t)}this.showHidePlug()},showHidePlug:function(){this.files().where({opened:!0}).length<1?this.$plug.show():this.$plug.hide()},share:function(){$("#share-modal").modal("show")},showManualModal:function(){$("#manual-modal").modal("show")},sendToMentor:function(){var e=this;this.files().getUnsavedFiles().length&&App.alertsView.showWarnings({message:App.Translations("projectNotSavedBeforeSentToReview")}),this.bootcampProjectReviewSubmitModal.show().done(function(t,i,n){new App.Models.BootcampProjectReview({project_id:e.project.get("id"),submodules:t,comment:i}).save(null,{wait:!0,error:function(e,t){App.alertsView.showErrors({message:App.Translations("projectSentToReviewError")})}}).done(function(){App.alertsView.showSuccess({message:App.Translations("projectSentToReview")});var t=e.navbar.$(".project-status");t.html(n),t.removeClass(),t.addClass("project-status project-in-review"),e.bootcampProjectReviewSubmitModal.reset(),e.bootcampProjectReviewSubmitModal.hide()})})},review:function(e,t,i){return this.project.get("bootcamp_project_review").set({accepted:e,annotations:t}).save()},edit:function(){$("#edit-modal").modal("show")},addSavedFileToMainTreeView:function(e,t){this.treeView.removeNode(this.activeFile.get("treeNode"));var i=this.treeViewNodes.get(e.dataObject),n=this.treeView.addNode(i,{text:t,icon:"fa fa-file",file:this.activeFile});this.treeView.revealNode(n)},saveFile:function(){if(App.alertsView.hideAll(),this.activeFile.isNew()){var e=this;return this.fileSaveModal.show(this.treeViewData).done(function(t,i,n,o){t||e.activeFile.set({path:i,filename:n}).save().done(function(){e.addSavedFileToMainTreeView(o,n),e.setHighlightMode(),e.hide(),e.fileSaveModal.clearFilename()}).error(function(t){e.activeFile.set({path:"",filename:"untitled"}),App.alertsView.showErrors(t.responseJSON),e.hide()})})}return this.activeFile.save()},saveAllFiles:function(){var e=this.files().getUnsavedFiles();return e.length<1?$.Deferred():$.when.apply(null,e.map(function(e){return e.save()}))},hide:function(){this.fileSaveModal.hide()},isAutosaveEnabled:function(){return this.$autosave.hasClass("autosave-on")},resetAutosave:function(){if(clearInterval(this.autosaveInterval),this.isAutosaveEnabled()){var e=this;this.autosaveInterval=setInterval(function(){e.saveAllFiles().done($.proxy(e.updatePreview,e))},3e5)}},toggleAutosave:function(e){$(e.currentTarget).toggleClass("autosave-on"),this.resetAutosave(),e.stopPropagation()},newFile:function(){var e=this.files().add({filename:"untitled",path:"",project_id:this.projectId,mime:"",content:""});this.setActiveFile(e);var t=this.treeView.getNode(0),i=this.treeView.addNode(t,{text:"untitled",icon:"fa fa-file",file:e});this.treeView.revealNode(i)},deleteFile:function(e){e=e||this.activeFile,window.confirm(App.Translations("projectDeleteFileMessage")+" "+e.get("filename")+"?")&&(e.close(),e.destroy())},buildTreeViewData:function(){var e=[{text:"/",path:"",nodes:[]}],t={};return this.files().each(function(i){var n=e[0],o=[],s=i.get("path");(""===s?[]:s.split("/")).forEach(function(e){o.push(e);var i=o.join("/");t[i]||(t[i]={text:e,path:i,nodes:[]},n.nodes.push(t[i])),n=t[i]}),n.nodes.push({text:i.get("filename"),icon:"fa fa-file",file:i})}),e},prepareTreeView:function(){var e=this;this.treeViewData=this.buildTreeViewData(),this.treeView=this.$(".tree-view").treeview({color:"#428bca",showBorder:!1,data:this.treeViewData,expandIcon:"fa fa-folder",collapseIcon:"fa fa-folder-o",preventUnselect:!0,onNodeSelected:function(t,i){i.file?e.setActiveFile(i.file):e.treeView.expandNode(i.nodeId)},onNodeInitialized:function(t){e.treeViewNodes.set(t.dataObject,t)},onNodeBuilded:function(t,i){t.file?(t.file.set("treeNode",t),t.file.set("treeViewFile",new App.Views.TreeViewFile({editor:e,node:t,el:i}))):new App.Views.TreeViewFolder({editor:e,node:t,treeView:this,el:i})}}).data("treeview")},render:function(){this._super(),this.$plug=this.$(".ide > div.plug");var e=this.files();this.listenTo(e,"remove",this.fileRemoved),this.listenTo(e,"change:opened",this.fileOpenedOrClosed),this.listenTo(e,"change:css",this.cssCompiled);var t=e.findWhere({filename:"index.html"});t&&this.setActiveFile(t)},cssCompiled:function(e,t){e.set({css:null},{silent:!0});var i=[e.name(),"css"].join("."),n=this.files().findWhere({filename:i,path:e.get("path")});if(!n)return App.alertsView.showWarnings({message:App.Templates("createTargetCssFile")({filename:i})});setTimeout(function(){n.get("treeViewFile").shake()},0),n.setContent(t),n.get("editorSession").setValue(t)},fileRemoved:function(e){this.treeView.removeNode(e.get("treeNode"))},prepareView:function(){this._super(),this.isOwner||this.editor.setReadOnly(!0),this.prepareKeyboardShortcuts(),this.prepareTreeView()},prepareKeyboardShortcuts:function(){var e={"ctrl+alt+n":this.newFile,"ctrl+s":this.saveFile,"ctrl+r":this.reloadPreview,"ctrl+shift+s":this.saveAllFiles,"meta+s":this.saveFile,"meta+shift+s":this.saveAllFiles},t=this;$.each(e,function(e,i){t.editor.commands.bindKey(e,function(){i.call(t)}),key(e,function(e){e.preventDefault(),i.call(t)})})},onEditorContentChanged:function(e){this.editor.silent||(this.resetAutosave(),this.changeFileContent(),this.activeFile.set("unsaved",!0))},reloadPreview:function(){if(this.files().hasUnsavedFiles()&&window.confirm(App.Translations("projectReloadPreviewMessage")))return this.saveAllFiles().done($.proxy(this.updatePreview,this));this.updatePreview()},updatePreview:function(e){if(!0===e)return this.$iframe.get(0).contentWindow.location.reload(!0);this.activePreviewFile.loadToIframe(this.$iframe)}}),App.Views.TreeViewFile=Backbone.View.extend({events:{"click .btn-del":"deleteFile"},initialize:function(e){this.editor=e.editor,this.node=e.node,this.render()},render:function(){this.editor.isOwner&&"index.html"!=this.node.file.attributes.filename&&this.$el.append($('<i class="fa fa-trash btn-del" title="Usuń plik"></i>'))},deleteFile:function(e){this.editor.deleteFile(this.node.file),e.stopPropagation()},shake:function(){this.$el.animateCss("shake")}}),App.Views.TreeViewFolder=Backbone.View.extend({events:{"click .btn-del":"deleteFolder"},initialize:function(e){this.editor=e.editor,this.treeView=e.treeView,this.onDelete=e.onDelete,this.node=e.node,this.render()},render:function(){this.editor.isOwner&&this.$el.append($('<i class="fa fa-trash btn-del" title="Usuń folder"></i>'))},deleteFolder:function(e){if(e.stopPropagation(),window.confirm(App.Translations("projectTreeViewFolderDeleteFolderMessage"))){var t=this;this.editor.deleteFolder.call(this.editor,this.node.path).done(function(){t.treeView.removeNode(t.node),t.onDelete&&t.onDelete()})}}}),App.Views.BootcampProjectReviewSubmitModal=Backbone.View.extend({events:{"click .btn-save":"submit"},initialize:function(){this.$comment=this.$('textarea[name="comment"]'),this.$checkboxes=this.$('input[type="checkbox"]')},submit:function(e){e.stopPropagation();var t=$(e.currentTarget).data("status-name"),i=this.$checkboxes;i.length>1&&(i=i.filter(":checked")),this.defer.resolve(i.map(function(){return $(this).val()}).toArray(),this.$comment.val(),t)},show:function(){return this.defer=$.Deferred(),this.$el.modal("show"),this.defer},hide:function(){this.$el.modal("hide")},reset:function(){this.$checkboxes.prop("checked",!1),this.$comment.val("")}}),App.Views.BootcampProjectReviewCard=Backbone.View.extend({events:{"click .btn-save":"submit","click .btn-discard":"discard","click header":"showOrHide"},initialize:function(){this.$annotations=this.$('textarea[name="annotations"]')},showOrHide:function(){this.$el.toggleClass("open")},hide:function(){this.$el.removeClass("open")},submit:function(e){e.stopPropagation();var t=$(e.currentTarget).data("status-name");this.review(!0,this.$annotations.val(),t)},discard:function(e){e.stopPropagation();var t=$(e.currentTarget).data("status-name");this.review(!1,this.$annotations.val(),t)},review:function(e,t,i){var n=this;App.Editor.review(e,t,i).done(function(){var t=n.$(".project-status");t.removeClass(),t.html(i),e?t.addClass("project-status project-accepted"):t.addClass("project-status project-unaccepted"),n.reset(),n.hide()}).error(function(){App.alertsView.showErrors({message:App.Translations("responseSendToUserError")})})},reset:function(){this.$annotations.val("")}});